{% extends "basic-materialize/base.html" %}
{% block title %}{% if post %}{{post.title}}{% endif %}{% endblock %}
{% block style %}
<style>
  .hidden{
    display: none;
  }
</style>
{% endblock %}
{% block content %}
    <div class="container">
          <div id="main" role="main">
              <section class="content">
    {% if post %}
      <article >
    	<h3>{{ post.title }}</h3>
          <h5>By - {{ post.get_author() }}</h5>
        <p>
    	      {{ text | safe }}
        </p>
    	  <time datetime="{{ post.date_created.strftime('%Y-%m-%d') }}">
            Posted: {{ post.date_created.strftime('%m/%d/%Y') }}
        </time>

        {% if post.comments %}
        <div>
          {% for comment in post.comments if comment.published == 1 %}
            {% if loop.first %}
              <h4>Comments</h4>
              <div>
            {% endif %}
              <div class="comment {% if loop.index > 3 %}hidden hidden-{{post.id}}{% endif %}">

                <div class='author'>
                    {{ comment.get_author() }}
                </div>
                <div class="metadata">
                  <time datetime="{{ comment.date_created.strftime('%Y-%m-%d') }}">
                    {{ comment.date_created.strftime('%m/%d/%Y') }}
                  </time>
                  <div class="text">
                     {{ comment.comment }}
                  </div>
                </div>
               </div>
               {% if loop.index == 4 %}
                <button class='btn readmore' data-post='{{post.id}}'>Read More</button>
               {% endif %}
            {% if loop.last %}
              </div>
            {% endif %}
          {% endfor %}
          {% if current_user.is_authenticated %}
          <button class='btn comment' data-post='{{post.id}}'>Comment</button>
          {% endif %}
        </div>
        {% else %}
        {% if current_user.is_authenticated %}
        <div>
          <button class='btn comment' data-post='{{post.id}}'>Comment</button>
        </div>
        {% endif %}
        {% endif %}
      </div>
    </div>
    {% else %}
     <div>
      <p>Post not found</p>
     </div>
    {% endif %}
</div>

{% if current_user.is_authenticated %}

    <div id="comment-modal" class="modal">
    <div class="modal-content">
      <form method="POST" id='comment-form'>
      {% for f in form %}
        <div class='field'>
        {% if f.name == 'post' %}
          {{ f(id='post-id') }}
        {% else %}
          {{ f.label }}
          {{ f }}
        {% endif %}
        </div>
      {% endfor %}
      </form>
    </div>
    <div class="modal-footer">
      <input class='btn' type='submit' form="comment-form">
    </div>
  </div>

{% endif %}
{% endblock %}

{% block script %}
<script>
$(function(){
{% if current_user.is_authenticated %}

    $('#comment-modal').modal();

  $('button.comment').on('click', function(){
      $('#comment-form #post-id').val($(this).data('post'));
      $('#comment-modal').modal('open');
  });
{% endif %}
  $('button.readmore').on('click', function(){
      var post_id = $(this).data('post');
      $(this).hide();
      $('.hidden-' + post_id).show();
  });
})

</script>
{% endblock %}
